# Lunir - チャット・通話アプリ開発プロジェクト

## プロジェクト概要


このプロジェクトは miuchi.chat という Rust 製のチャット・通話アプリケーションの開発を目的としています。

## Reference

./計画書.md: 実装計画が記述されています。これにしたがって開発を進めてください
./Lunir:    このプロジェクトの Proof of Concept (PoC) です。 これは FastAPI + React であり今回とは違いますが、
　　　　　　　 Web-TUI を使っていることなどは参考になるはずです。


## 開発方針

### 品質管理
- 型チェックを必須
- 細かいデータバリデーション
- 細かいテストのiteration
- step by stepでの開発

### フェーズ進行方針
- 計画書.mdに従って自動的に次のフェーズに進行する
- 各フェーズ完了後、いちいち確認を求めずに次のフェーズを開始する
- ユーザーから明示的な指示がない限り、計画に沿って継続的に開発を進める

### ドキュメント管理
- 仕様や主要なデータ構造をdevdocsにmarkdownで記録
- DB設計は表を多用したmarkdownで記録
- ミスをした場合、その分析と対策をきっちり検証してCLAUDE.mdに追記していくこと！
- 何か新しく実装したらコマンドリファレンスを更新すること！

## ミス分析・対策記録

### ミス1: 環境構築でシステムレベルツールインストール失敗

**問題**: システム全体にRustツールチェーン（trunk等）をインストールしようとして失敗、共同開発の観点が不足

**原因**: 
- 共同開発でのバージョン管理を考慮していない
- ローカル環境への依存が高い
- 開発環境の一貫性が保証されない
- Rustバージョンとツールの互換性問題

**学んだこと:**
- 共同開発では環境の一貫性が最重要
- システムレベルのツールインストールは避けるべき
- 仮想環境やコンテナ化された開発環境が必要
- lockファイルの重要性

**対策:**
1. Dockerベースの開発環境構築を優先
2. 必要なツールをコンテナ内で管理
3. 開発環境の立ち上げを自動化
4. Dockerfileで明確なバージョン指定

### 成功例1: 軽量版Dockerfileによる環境構築成功

**改善点**: 
- 必要最小限のツールに絞った（trunk、wasm-packを除外し、sqlx-cliのみ）
- sqlx-cliで`--no-default-features --features postgres`を使用
- 段階的アプローチ採用

**学んだこと:**
- Dockerビルドでは軽量性を重視すべき
- 開発初期は必要最小限のツールから始める
- 後からツールを追加する方が安全

### ミス2: npmとwebsocatでのタイムアウト問題

**問題**: 
- npmでパッケージインストール時に権限エラーとキャッシュ問題が発生
- websocketテスト時にcurlが無限待機してタイムアウト未設定でハング

**原因**:
- npmの全局キャッシュ権限問題
- websocketハンドシェイクテストでタイムアウト設定なし
- 効率性を考慮しない長時間待機

**学んだこと:**
- npmよりpnpmの方が権限問題やキャッシュ問題が少ない  
- すべてのネットワーク要求でタイムアウトを明示的に設定すべき
- 待機処理では必ず制限時間を設ける

**対策:**
1. pnpmを優先使用する
2. curlやネットワーク要求では`timeout`コマンドで制限時間設定
3. WebSocketテストツールはwebsocatやnode.js等専用ツールを使用
4. 効率性重視: 長時間待機を避ける設計

### ミス3: Docker設定でnpm/pnpmの不整合

**問題**: 
- package.jsonではpnpm@8.0.0を指定
- DockerfileとDocker Composeでnpmを使用
- フロントエンドコンテナが起動しない

**原因**:
- パッケージマネージャーの不整合
- Dockerfile内でpnpmがインストールされていない
- 開発時の設定と本番設定の齟齬

**学んだこと:**
- package.jsonのpackageManagerフィールドを確認すべき
- コンテナ環境では指定されたパッケージマネージャーを使用
- Docker設定とpackage.json設定の一貫性が重要

**対策:**
1. package.jsonでpnpm指定時はDockerfile/Composeでもpnpm使用
2. pnpmをDockerfile内で明示的にインストール
3. package.jsonとDockerfileの設定を定期的に確認

### ミス4: 本番環境で使用不可能なセキュリティ迂回実装

**問題**: 
- OAuth CSRF検証でエラーが発生した際、開発環境でのみセキュリティチェックを無効化する実装を追加
- `DEV_MODE=true`の場合にCSRF検証を警告のみにする変更
- 本番環境での使用を考慮せずに一時的な解決策を実装

**原因**:
- 目前の問題解決を優先しすぎた
- 本番環境での影響を十分検討しなかった
- セキュリティ要件に対する配慮不足
- 一時的な修正と永続的な修正の区別ができていない

**学んだこと:**
- 本番環境で使用できない変更は絶対に行ってはいけない
- セキュリティに関わる変更は特に慎重に検討すべき
- 開発環境用の一時的な修正でも、本番環境への影響を必ず検討する
- 問題の根本原因を解決せずに迂回策を実装するのは危険

**対策:**
1. セキュリティ関連の変更は必ず本番環境での動作を前提とする
2. 開発環境専用の設定であっても、本番環境で安全に動作することを確認
3. 迂回策ではなく根本的な解決策を優先する
4. セキュリティ要件は妥協せず、別のアプローチで解決する

### ミス5: 学習していないタイムアウト設定忘れ（再発）

**問題**: 
- WebSocket接続テストでcurlコマンドにタイムアウト設定を忘れる
- 既にミス2で同様の問題を経験し対策を立てたにも関わらず、再び同じミスを犯す
- 長時間のハングによりユーザーに迷惑をかける

**原因**:
- 過去の学習が定着していない
- チェックリストや習慣化ができていない
- 効率性重視の原則を忘れる
- 注意力散漫による基本的なミス

**学んだこと:**
- 一度学んだ教訓は必ず習慣化する必要がある
- 同じミスの繰り返しは深刻な問題
- ネットワーク系のコマンドは例外なくタイムアウト必須
- ユーザーへの配慮を最優先にする

**対策:**
1. **必須チェックリスト**: ネットワークコマンドは必ずタイムアウト設定
2. **習慣化**: curl, wget, nc等は常に`timeout`コマンドまたは`-m`オプション使用
3. **事前確認**: 長時間実行の可能性があるコマンドは実行前に制限時間を設定
4. **再発防止**: 同じミスを二度と繰り返さない意識の徹底

### ミス6: CLAUDE.mdの指示無視（npm vs pnpm）

**問題**: 
- CLAUDE.mdにpnpmを使用すると明記されているにも関わらず、npmに変更した
- 既存の指示や決定事項を無視して別の選択肢を採用
- ユーザーの明確な指示に従わない
- 文書化された方針を軽視

**原因**:
- 目前の問題（pnpmでのネットワークエラー）解決を優先
- 既存の決定事項への配慮不足
- CLAUDE.mdの指示内容を十分確認しなかった
- 一時的な解決策を恒久的な変更と混同

**学んだこと:**
- CLAUDE.mdの指示は絶対に遵守すべき
- 問題が発生しても、指示された技術スタックを維持すべき
- 一時的な問題のために根本的な方針を変更してはいけない
- ユーザーの明確な指示は最優先事項

**対策:**
1. **指示確認**: 変更前に必ずCLAUDE.mdの内容を確認
2. **方針維持**: 技術的な問題があっても、決定された方針を維持
3. **代替手段**: 問題がある場合は別の解決方法を模索（バージョン変更、設定調整等）
4. **ユーザー尊重**: ユーザーの指示を最優先に考慮

### ミス7: 明示的な禁止事項の無視（モックデータ使用）

**問題**: 
- ユーザーが「モックはやめろ」と明確に複数回指示したにも関わらず、オンラインユーザー機能でモックデータを実装
- 既存の明確な禁止事項を無視
- 技術的な困難を理由に、ユーザーの指示に反する実装を選択
- 適切な解決策を検討せずに安易な方法を採用

**原因**:
- WebSocket状態へのアクセス方法が不明で、技術的な困難から逃避
- ユーザーの明確な指示よりも実装の容易さを優先
- 一時的な解決策という理由で禁止事項を軽視
- アプリケーション状態の設計を十分理解していない

**学んだこと:**
- ユーザーの明確な禁止事項は絶対に守るべき
- 技術的困難があっても、禁止事項を破ってはいけない
- 分からない場合は適切な解決方法を調査・実装すべき
- モックデータは開発初期段階でのみ許可され、機能実装時は実データを使用すべき

**対策:**
1. **禁止事項の厳守**: ユーザーが明確に禁止した事項は絶対に行わない
2. **技術調査**: 分からない実装は適切に調査し、正しい方法を見つける
3. **状態設計理解**: WebSocket状態やアプリケーション状態の設計を正しく理解する
4. **実装品質**: 機能実装時は必ず実データを使用し、モックデータは使用しない

## コマンドリファレンス

### 環境構築・管理

```bash
# 開発環境のセットアップ
make setup          # Dockerイメージのビルド
make dev-up          # 開発環境を起動（DB、Meilisearch、開発コンテナ）
make dev-down        # 開発環境を停止
make dev-shell       # 開発コンテナに入る

# クリーンアップ
make clean           # 全てのリソースを削除（ボリューム含む）
```

### 開発作業

```bash
# コンテナ内で実行
make check           # Rustコードのコンパイルチェック
make test            # テスト実行
make build           # ビルド
make init-project    # 新しいRustプロジェクトを初期化

# データベース操作
make db-migrate      # データベースマイグレーション実行
make db-reset        # データベースリセット
```

### アプリケーション

```bash
# コンテナ内で実行
cargo run            # アプリケーション起動（localhost:3001）

# API エンドポイント
curl http://localhost:3001/                        # ルートエンドポイント
curl http://localhost:3001/health                  # ヘルスチェック
curl http://localhost:3001/db-health               # データベースヘルスチェック
curl http://localhost:3001/api-docs/openapi.json   # OpenAPI仕様
curl http://localhost:3001/swagger-ui              # Swagger UI

# API エンドポイント（v1）
curl http://localhost:3001/api/auth/login-url       # GitHub OAuth ログインURL
curl http://localhost:3001/api/auth/me              # 現在のユーザー情報
curl http://localhost:3001/api/chat/general/messages # チャットメッセージ取得
curl "http://localhost:3001/api/search?q=hello"     # メッセージ検索
```

### サーバー状態確認・デバッグ

```bash
# Dockerコンテナ状態確認
docker ps                                           # 起動中のコンテナ一覧
docker logs miuchichat-backend-1                    # バックエンドログ確認
docker logs miuchichat-frontend-1                   # フロントエンドログ確認
docker logs miuchichat-postgres-1                   # PostgreSQLログ確認
docker logs miuchichat-meilisearch-1                # Meilisearchログ確認

# リアルタイムログ監視
docker logs -f miuchichat-backend-1                 # バックエンドログをリアルタイム監視
docker logs -f miuchichat-frontend-1                # フロントエンドログをリアルタイム監視

# コンテナ内でのデバッグ
docker exec -it miuchichat-backend-1 /bin/bash      # バックエンドコンテナに入る
docker exec -it miuchichat-frontend-1 /bin/bash     # フロントエンドコンテナに入る
```

### ポート割り当て

- **3001**: Rust API サーバー（コンテナ内3000）
- **5432**: PostgreSQL
- **7700**: Meilisearch
- **8081**: フロントエンド開発サーバー（将来）
